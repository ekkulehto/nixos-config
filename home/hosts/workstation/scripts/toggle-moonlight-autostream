#!/usr/bin/env bash
set -euo pipefail

SERVICE="moonlight-autostream.service"

IPC=(noctalia-shell ipc call)

toast() {
  local title="$1"
  local body="${2:-}"
  local icon="${3:-}"
  local type="${4:-notice}"
  local duration="${5:-3000}"

  title=${title//\"/\\\"}
  body=${body//\"/\\\"}
  icon=${icon//\"/\\\"}

  local json
  if [[ -n "$icon" ]]; then
    json=$(printf '{"title":"%s","body":"%s","icon":"%s","type":"%s","duration":%s}' \
      "$title" "$body" "$icon" "$type" "$duration")
  else
    json=$(printf '{"title":"%s","body":"%s","type":"%s","duration":%s}' \
      "$title" "$body" "$type" "$duration")
  fi

  "${IPC[@]}" toast send "$json" >/dev/null 2>&1 || true
}

if systemctl --user is-active --quiet "$SERVICE"; then
  systemctl --user stop "$SERVICE"
  toast "Moonlight" "Remote desktop to Windows ended" "player-stop" "notice" 3000
else
  systemctl --user start "$SERVICE"
  toast "Moonlight" "Remote desktop to Windows started" "player-play" "notice" 3000
fi
